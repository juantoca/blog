---
import { Icon } from 'astro-icon/components'
import { getAvailableLanguages, getLanguageFromUrl, getLocalizedUrl } from '@/lib/i18n'

interface Props {
  
  currentPath: string
  class?: string
}

const { currentPath, class: className } = Astro.props
const currentLanguage = getLanguageFromUrl(Astro.url.pathname)
const languages = getAvailableLanguages()

// Convert current path to language-agnostic version
const getBasePathForTranslation = (path: string) => {
  const segments = path.split('/').filter(Boolean)
  const firstSegment = segments[0]
  
  // If first segment is a language, remove it
  if (languages.some(lang => lang.code === firstSegment)) {
    return '/' + segments.slice(1).join('/')
  }
  
  return path
}

const basePath = getBasePathForTranslation(currentPath)
---

<div class={`relative ${className || ''}`}>
  <button
    class="flex items-center gap-2 px-3 py-2 text-sm rounded-md hover:bg-muted transition-colors"
    aria-expanded="false"
    aria-haspopup="true"
    data-language-switcher
  >
    <Icon name="lucide:globe" class="size-4" />
    <span class="font-medium">
      {languages.find(lang => lang.code === currentLanguage)?.name}
    </span>
    <Icon name="lucide:chevron-down" class="size-4" />
  </button>
  
  <div 
    class="absolute right-0 top-full mt-2 min-w-[160px] bg-background border rounded-md shadow-lg z-50 opacity-0 invisible transition-all duration-200"
    data-language-menu
  >
    {languages.map((language) => (
      <a
        href={getLocalizedUrl(basePath, language.code)}
        class={`flex items-center gap-3 px-4 py-3 text-sm hover:bg-muted transition-colors first:rounded-t-md last:rounded-b-md ${
          language.code === currentLanguage 
            ? 'bg-muted font-medium' 
            : ''
        }`}
        data-language={language.code}
      >
        <span class="text-muted-foreground text-xs font-mono uppercase">
          {language.code}
        </span>
        <span>{language.name}</span>
        {language.code === currentLanguage && (
          <Icon name="lucide:check" class="size-4 ml-auto text-primary" />
        )}
      </a>
    ))}
  </div>
</div>

<script is:inline>
  function initLanguageSwitcher() {
    const switcher = document.querySelector('[data-language-switcher]')
    const menu = document.querySelector('[data-language-menu]')
    
    if (!switcher || !menu) {
      // Retry after a short delay if elements aren't ready
      setTimeout(initLanguageSwitcher, 50)
      return
    }
    
    let isOpen = false
    let clickOutsideHandler = null
    let keydownHandler = null
    
    const toggleMenu = () => {
      isOpen = !isOpen
      if (isOpen) {
        menu.classList.remove('opacity-0', 'invisible')
        menu.classList.add('opacity-100', 'visible')
        switcher.setAttribute('aria-expanded', 'true')
      } else {
        menu.classList.add('opacity-0', 'invisible')
        menu.classList.remove('opacity-100', 'visible')
        switcher.setAttribute('aria-expanded', 'false')
      }
    }
    
    const closeMenu = () => {
      if (isOpen) {
        isOpen = false
        menu.classList.add('opacity-0', 'invisible')
        menu.classList.remove('opacity-100', 'visible')
        switcher.setAttribute('aria-expanded', 'false')
      }
    }
    
    // Button click handler
    switcher.addEventListener('click', (e) => {
      e.preventDefault()
      e.stopPropagation()
      toggleMenu()
    })
    
    // Close menu when clicking outside
    clickOutsideHandler = (e) => {
      if (!switcher.contains(e.target) && !menu.contains(e.target)) {
        closeMenu()
      }
    }
    document.addEventListener('click', clickOutsideHandler)
    
    // Prevent menu from closing when clicking inside it
    menu.addEventListener('click', (e) => {
      e.stopPropagation()
    })
    
    // Close menu on escape
    keydownHandler = (e) => {
      if (e.key === 'Escape') {
        closeMenu()
      }
    }
    document.addEventListener('keydown', keydownHandler)
    
    // Set initial aria-expanded state
    switcher.setAttribute('aria-expanded', 'false')
  }
  
  // Initialize immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLanguageSwitcher)
  } else {
    initLanguageSwitcher()
  }
  
  // Also handle Astro page navigation
  document.addEventListener('astro:page-load', initLanguageSwitcher)
</script>