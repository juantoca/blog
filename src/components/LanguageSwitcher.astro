---
import { Button } from '@/components/ui/button'
import {
  getAvailableLanguages,
  getLanguageFromUrl,
  getLocalizedUrl,
} from '@/lib/i18n'
import { Icon } from 'astro-icon/components'

interface Props {
  currentPath: string
  class?: string
}

const { currentPath, class: className } = Astro.props
const currentLanguage = getLanguageFromUrl(Astro.originPathname)
const languages = getAvailableLanguages()

// Convert current path to language-agnostic version
const getBasePathForTranslation = (path: string) => {
  const segments = path.split('/').filter(Boolean)
  const firstSegment = segments[0]

  // If first segment is a language, remove it
  if (languages.some((lang) => lang.code === firstSegment)) {
    return '/' + segments.slice(1).join('/')
  }

  return path
}

const basePath = getBasePathForTranslation(currentPath)
---

<Button
  className="md:hover:bg-muted relative size-9 border md:-my-2 md:-me-2 md:size-8 md:border-0 md:bg-transparent"
  aria-expanded="false"
  aria-haspopup="true"
  variant="outline"
  size="icon"
  data-language-switcher
>
  <Icon name="lucide:globe" class="h-5 w-5 md:h-4 md:w-4" />

  <div
    class="bg-background invisible absolute top-full right-0 z-50 mt-2 min-w-[160px] rounded-md border opacity-0 shadow-lg transition-all duration-200"
    data-language-menu
  >
    {
      languages.map((language) => (
        <a
          href={getLocalizedUrl(basePath, language.code)}
          class={`hover:bg-muted flex items-center gap-3 px-4 py-3 text-sm transition-colors first:rounded-t-md last:rounded-b-md ${
            language.code === currentLanguage ? 'bg-muted font-medium' : ''
          }`}
          data-language={language.code}
        >
          <span class="text-muted-foreground font-mono text-xs uppercase">
            {language.code}
          </span>
          <span>{language.name}</span>
          {language.code === currentLanguage && (
            <Icon name="lucide:check" class="text-primary ml-auto size-4" />
          )}
        </a>
      ))
    }
  </div>
</Button>

<script is:inline>
  function initLanguageSwitcher() {
    const switcher = document.querySelector('[data-language-switcher]')
    const menu = document.querySelector('[data-language-menu]')

    if (!switcher || !menu) {
      // Retry after a short delay if elements aren't ready
      setTimeout(initLanguageSwitcher, 50)
      return
    }

    let isOpen = false
    let clickOutsideHandler = null
    let keydownHandler = null

    const toggleMenu = () => {
      isOpen = !isOpen
      if (isOpen) {
        menu.classList.remove('opacity-0', 'invisible')
        menu.classList.add('opacity-100', 'visible')
        switcher.setAttribute('aria-expanded', 'true')
      } else {
        menu.classList.add('opacity-0', 'invisible')
        menu.classList.remove('opacity-100', 'visible')
        switcher.setAttribute('aria-expanded', 'false')
      }
    }

    const closeMenu = () => {
      if (isOpen) {
        isOpen = false
        menu.classList.add('opacity-0', 'invisible')
        menu.classList.remove('opacity-100', 'visible')
        switcher.setAttribute('aria-expanded', 'false')
      }
    }

    // Button click handler
    switcher.addEventListener('click', (e) => {
      e.preventDefault()
      e.stopPropagation()
      toggleMenu()
    })

    // Close menu when clicking outside
    clickOutsideHandler = (e) => {
      if (!switcher.contains(e.target) && !menu.contains(e.target)) {
        closeMenu()
      }
    }
    document.addEventListener('click', clickOutsideHandler)

    // Prevent menu from closing when clicking inside it
    menu.addEventListener('click', (e) => {
      e.stopPropagation()
    })

    // Close menu on escape
    keydownHandler = (e) => {
      if (e.key === 'Escape') {
        closeMenu()
      }
    }
    document.addEventListener('keydown', keydownHandler)

    // Set initial aria-expanded state
    switcher.setAttribute('aria-expanded', 'false')
  }

  // Initialize immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLanguageSwitcher)
  } else {
    initLanguageSwitcher()
  }

  // Also handle Astro page navigation
  document.addEventListener('astro:page-load', initLanguageSwitcher)
</script>
